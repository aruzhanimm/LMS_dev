<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - EduSphere LMS</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .profile-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            background: var(--primary-purple);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
        }
        .profile-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--medium-gray);
            padding-bottom: 0.5rem;
        }
        .profile-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: var(--light-gray);
            border-bottom: 2px solid transparent;
            margin-bottom: -0.5rem;
        }
        .profile-tab.active {
            color: var(--primary-purple);
            border-bottom-color: var(--primary-purple);
        }
        .profile-content {
            display: none;
        }
        .profile-content.active {
            display: block;
        }
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
    </style>
</head>
<body>

    <main class="container">
        <div class="profile-header">
            <h1>My Profile</h1>
            <div>
                <a href="/add-course" class="btn"><i class="fas fa-plus"></i> Add Course</a>
                <button id="logoutBtn" class="btn btn-secondary" style="margin-left: 1rem;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="profile-info glass-card">
            <div class="profile-avatar" id="userAvatar">
                U
            </div>
            <div>
                <h2 id="userName">Loading...</h2>
                <p id="userEmail">Loading...</p>
            </div>
        </div>

        <div class="profile-tabs">
            <div class="profile-tab active" data-tab="enrolled">Enrolled Courses</div>
            <div class="profile-tab" data-tab="created">Created Courses</div>
        </div>

        <div id="enrolledContent" class="profile-content active">
            <h3>My Learning</h3>
            <div id="enrolledCourses" class="course-grid">
                <!-- Courses will be loaded here -->
            </div>
        </div>

        <div id="createdContent" class="profile-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>My Created Courses</h3>
                <a href="/add-course" class="btn"><i class="fas fa-plus"></i> Create New Course</a>
            </div>
            <div id="createdCourses" class="course-grid">
                <!-- Created courses will be loaded here -->
            </div>
        </div>
    </main>


    <script>
        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch('/api/auth/me');
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }

                const data = await response.json();
                if (data.user) {
                    document.getElementById('userName').textContent = data.user.username;
                    document.getElementById('userEmail').textContent = data.user.email;
                    document.getElementById('userAvatar').textContent = data.user.username.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load enrolled courses
        async function loadEnrolledCourses() {
            try {
                const response = await fetch('/api/auth/my-courses');
                const data = await response.json();

                const container = document.getElementById('enrolledCourses');
                if (data.courses && data.courses.length > 0) {
                    container.innerHTML = data.courses.map(course => `
                        <div class="course-card glass-card hover-scale">
                            <div class="card-img-top">
                                <img src="${course.image}" alt="${course.title}" style="height: 150px; object-fit: cover;">
                            </div>
                            <div class="card-body">
                                <div class="card-meta">
                                    <span class="category">${course.category}</span>
                                    <span class="rating"><i class="fas fa-star"></i> ${course.rating}</span>
                                </div>
                                <h3 class="course-title">${course.title}</h3>
                                <p class="instructor">By ${course.instructor}</p>
                                <div class="progress-bar" style="margin: 10px 0;">
                                    <div style="background: var(--medium-gray); height: 5px; border-radius: 3px;">
                                        <div style="background: var(--primary-purple); width: ${course.progress || 0}%; height: 100%; border-radius: 3px;"></div>
                                    </div>
                                    <small>Progress: ${course.progress || 0}%</small>
                                </div>
                                <div class="card-footer">
                                    <span class="price">$${course.price}</span>
                                    <a href="/item/${course._id}" class="btn-sm">Continue</a>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>You have not enrolled in any courses yet.</p>';
                }
            } catch (error) {
                console.error('Error loading enrolled courses:', error);
            }
        }

        // Load created courses
        async function loadCreatedCourses() {
            try {
                const response = await fetch('/api/auth/created-courses');
                const data = await response.json();

                const container = document.getElementById('createdCourses');
                if (data.courses && data.courses.length > 0) {
                    container.innerHTML = data.courses.map(course => `
                        <div class="course-card glass-card hover-scale">
                            <div class="card-img-top">
                                <img src="${course.image}" alt="${course.title}" style="height: 150px; object-fit: cover;">
                            </div>
                            <div class="card-body">
                                <div class="card-meta">
                                    <span class="category">${course.category}</span>
                                    <span class="enrolled"><i class="fas fa-users"></i> ${course.enrolledCount || 0}</span>
                                </div>
                                <h3 class="course-title">${course.title}</h3>
                                <p class="instructor">By ${course.instructor}</p>
                                <div class="card-footer">
                                    <span class="price">$${course.price}</span>
                                    <div>
                                        <a href="/item/${course._id}" class="btn-sm" style="margin-right: 5px;">View</a>
                                        <button class="btn-sm btn-secondary" onclick="editCourse('${course._id}')">Edit</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>You have not created any courses yet.</p>';
                }
            } catch (error) {
                console.error('Error loading created courses:', error);
            }
        }

        // Tab switching
        document.querySelectorAll('.profile-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.profile-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Content').classList.add('active');

                if (tab.dataset.tab === 'enrolled') {
                    loadEnrolledCourses();
                } else if (tab.dataset.tab === 'created') {
                    loadCreatedCourses();
                }
            });
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        });

        // Edit course function
        window.editCourse = function(courseId) {
            window.location.href = `/add-course?edit=${courseId}`;
        };

        // Initial load
        loadUserData();
        loadEnrolledCourses();
    </script>
</body>
</html>